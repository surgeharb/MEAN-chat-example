var app=angular.module("chat",["ngRoute","ngSanitize"]);app.config(["$routeProvider","$locationProvider",function(e,n){n.html5Mode(!0),e.when("/",{templateUrl:"views/chat/chat.html",controller:"ChatController",title:"Chat"}).when("/login",{templateUrl:"views/login/login.html",controller:"LoginController",title:"Login"}).otherwise({redirectTo:"/404"})}]),app.run(["$location","$rootScope",function(e,n){n.$on("$routeChangeSuccess",function(e,t,r){t.hasOwnProperty("$$route")&&(n.title=t.$$route.title)})}]),app.controller("MainCtrl",["$scope",function(e){}]),function(){"use strict";function e(e,n){function t(t){var r=t.data,o=e.defer();return n({url:"/"+t.type,data:r,method:t.requestType}).then(function(e,n,t,r){o.resolve(e)},function(e,n){o.reject()}),o.promise}this.gatewayCall=t}app.service("apiService",e),e.$inject=["$q","$http"]}(),function(){"use strict";function e(){var e={},n="";return{updateUser:function(n){e=n},getUser:function(){return e},setToken:function(e){n=e},getToken:function(){return n}}}app.service("userService",e)}(),app.controller("ChatController",["$scope","$location","apiService","userService",function(e,n,t,r){function o(e){return e<10?"0"+e:e}function a(){$("#conversation .body").stop().animate({scrollTop:$("#conversation .body").prop("scrollHeight")},500)}e.user=r.getUser(),e.token=r.getToken();var s=io();s.emit("join",e.user.username),s.on("update",function(e){console.log(e)}),s.on("receive",function(n){if(n.sender==e.user.username)e.conversations[n.receiver].push(n),e.$apply();else{if(n.receiver!=e.user.username)return!1;e.conversations[n.sender].push(n),e.$apply()}}),e.conversations={},"cedric"==e.user.username?(e.chatConversations=[{_id:"123456789abd",name:"Serge Harb",username:"surgeharb",profilePicture:"http://files.sergeharb.com/img/Me.jpg",lastmessage:{content:"Hello Man",status:"none",date:"22/02/2012 11:12:11"}}],e.conversations.surgeharb=[{date:"22/02/2012 11:12:11",content:"Hello Man",sender:"cedric",receiver:"surgeharb"}]):(e.chatConversations=[{_id:"123456789abc",name:"Cedric Harb",username:"cedric",profilePicture:"https://scontent-mxp1-1.xx.fbcdn.net/v/t1.0-9/10981992_854381584636591_4594131235025284689_n.jpg?oh=0177b6d4c5e300a93cfa20de639bd235&oe=592BF9D9",lastmessage:{content:"Hello Man",status:"none",date:"22/02/2012 11:12:11"}}],e.conversations.cedric=[{date:"22/02/2012 11:12:11",content:"Hello Man",sender:"cedric",receiver:"surgeharb"}]),e.conv={},e.conv.user={},e.sendMessage=function(){if(e.message){var n=new Date,t={date:o(n.getDate())+"/"+o(n.getMonth()+1)+"/"+o(n.getFullYear())+" "+o(n.getHours())+":"+o(n.getMinutes())+":"+o(n.getSeconds()),content:e.message,sender:e.user.username,receiver:e.conv.user.username};s.emit("send",t),e.message="",t={},a()}},e.checkEnter=function(n){13===n.keyCode&&e.sendMessage()},e.getTime=function(e){var n=e.split(" ")[1],t=n.split(":");return o(parseInt(t[0]))+":"+o(parseInt(t[1]))},e.fetchConversation=function(n){e.conv.user._id=n._id,e.conv.user.name=n.name,e.conv.user.username=n.username,e.conv.user.profilePicture=n.profilePicture}}]),app.controller("LoginController",["$scope","$location","apiService","userService",function(e,n,t,r){e.login=function(){var o={type:"api/login",requestType:"POST",data:{username:e.username,password:e.password}};t.gatewayCall(o).then(function(t){e.token=r.setToken(t.data.token),e.user=r.updateUser(t.data.user),n.path("/")})}}]);