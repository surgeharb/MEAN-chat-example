var app=angular.module("chat",["ngRoute","ngSanitize","ngStorage"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function(e,t,n){t.html5Mode(!0),e.when("/",{templateUrl:"views/chat/chat.html",controller:"ChatController",title:"Chat"}).when("/login",{templateUrl:"views/login/login.html",controller:"LoginController",title:"Login"}).otherwise({redirectTo:"/404"})}]),app.run(["$location","$rootScope","$http","$localStorage",function(e,t,n,o){o.User&&(n.defaults.headers.common.Authorization="Bearer "+o.User.token),t.$on("$routeChangeSuccess",function(e,n,o){n.hasOwnProperty("$$route")&&(t.title=n.$$route.title)}),t.$on("$locationChangeStart",function(t,n,r){["/login","/404"].indexOf(e.path())===-1&&!o.User&&e.path("/login")})}]),app.controller("MainCtrl",["$scope",function(e){}]),function(){"use strict";function e(e,t){function n(n){var o=n.data,r=e.defer();return t({url:"/"+n.type,data:o,method:n.requestType}).then(function(e,t,n,o){r.resolve(e)},function(e,t){r.reject()}),r.promise}this.gatewayCall=n}app.service("apiService",e),e.$inject=["$q","$http"]}(),function(){"use strict";function e(e,t,n,o){function r(r,a,i){var s={username:r,password:a},c={type:"api/login",requestType:"POST",data:s};n.gatewayCall(c).then(function(n){n.data.token?(t.User={username:n.data.user.username,token:n.data.token},e.defaults.headers.common.Authorization="Bearer "+n.data.token,o.setToken(n.data.token),o.updateUser(n.data.user),i(!0)):i(!1)},function(){i(!1)})}function a(){delete t.User,e.defaults.headers.common.Authorization=""}var i={};return i.Login=r,i.Logout=a,i}app.factory("authService",e),e.$inject=["$http","$localStorage","apiService","userService"]}(),function(){"use strict";function e(){var e={},t="";return{updateUser:function(t){e=t},getUser:function(){return e},setToken:function(e){t=e},getToken:function(){return t}}}app.service("userService",e)}(),app.controller("ChatController",["$scope","$location","apiService","userService",function(e,t,n,o){function r(e){return e<10?"0"+e:e}function a(){$("#conversation .body").stop().animate({scrollTop:$("#conversation .body").prop("scrollHeight")},500)}e.user=o.getUser(),e.token=o.getToken();var i=io.connect("http://localhost:9000");i.on("connect",function(){i.emit("authenticate",{token:myAuthToken})}),i.on("auth",function(){i.emit("join",e.user.username),i.on("update",function(e){console.log(e)}),i.on("receive",function(t){if(t.sender==e.user.username)e.conversations[t.receiver].push(t),e.$apply();else{if(t.receiver!=e.user.username)return!1;e.conversations[t.sender].push(t),e.$apply()}})}),e.conversations={},"cedric"==e.user.username?(e.chatConversations=[{_id:"123456789abd",name:"Serge Harb",username:"surgeharb",profilePicture:"http://files.sergeharb.com/img/Me.jpg",lastmessage:{content:"Hello Man",status:"none",date:"22/02/2012 11:12:11"}}],e.conversations.surgeharb=[{date:"22/02/2012 11:12:11",content:"Hello Man",sender:"cedric",receiver:"surgeharb"}]):(e.chatConversations=[{_id:"123456789abc",name:"Cedric Harb",username:"cedric",profilePicture:"https://scontent-mxp1-1.xx.fbcdn.net/v/t1.0-9/10981992_854381584636591_4594131235025284689_n.jpg?oh=0177b6d4c5e300a93cfa20de639bd235&oe=592BF9D9",lastmessage:{content:"Hello Man",status:"none",date:"22/02/2012 11:12:11"}}],e.conversations.cedric=[{date:"22/02/2012 11:12:11",content:"Hello Man",sender:"cedric",receiver:"surgeharb"}]),e.conv={},e.conv.user={},e.sendMessage=function(){if(e.message){var t=new Date,n={date:r(t.getDate())+"/"+r(t.getMonth()+1)+"/"+r(t.getFullYear())+" "+r(t.getHours())+":"+r(t.getMinutes())+":"+r(t.getSeconds()),content:e.message,sender:e.user.username,receiver:e.conv.user.username};i.emit("send",n),e.message="",n={},a()}},e.checkEnter=function(t){13===t.keyCode&&e.sendMessage()},e.getTime=function(e){var t=e.split(" ")[1],n=t.split(":");return r(parseInt(n[0]))+":"+r(parseInt(n[1]))},e.fetchConversation=function(t){e.conv.user._id=t._id,e.conv.user.name=t.name,e.conv.user.username=t.username,e.conv.user.profilePicture=t.profilePicture}}]),app.controller("LoginController",["$scope","$location","authService",function(e,t,n){e.login=function(){n.Login(e.username,e.password,function(n){n?t.path("/"):(e.error="Your username or password is incorrect",e.loading=!1)})}}]);