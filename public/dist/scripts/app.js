var app=angular.module("chat",["ngRoute","ngSanitize","ngStorage"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function(e,t,n){t.html5Mode(!0),e.when("/",{templateUrl:"views/chat/chat.html",controller:"ChatController",title:"Chat"}).when("/login",{templateUrl:"views/login/login.html",controller:"LoginController",title:"Login"}).otherwise({redirectTo:"/404"})}]),app.run(["$location","$rootScope","$http","$localStorage","userService","authService",function(e,t,n,r,o,a){r.User&&(n.defaults.headers.common.Authorization="Bearer "+r.User.token,o.setToken(r.User.token)),t.$on("$routeChangeSuccess",function(e,n,r){n.hasOwnProperty("$$route")&&(t.title=n.$$route.title)}),t.$on("$locationChangeStart",function(t,n,o){-1===["/login","/404"].indexOf(e.path())&&!r.User&&e.path("/login")})}]),function(){"use strict";function e(e,t){function n(n){var r=n.data,o=e.defer();return t({url:"/"+n.type,data:r,method:n.requestType}).then(function(e,t,n,r){o.resolve(e)},function(e,t){o.reject()}),o.promise}this.gatewayCall=n}app.service("apiService",e),e.$inject=["$q","$http"]}(),function(){"use strict";function e(e,t,n,r){function o(o,a,s){var i={username:o,password:a},c={type:"api/login",requestType:"POST",data:i};n.gatewayCall(c).then(function(n){n.data.token?(t.User={username:n.data.user.username,token:n.data.token},e.defaults.headers.common.Authorization="Bearer "+n.data.token,r.setToken(n.data.token),r.updateUser(n.data.user),s(!0)):s(!1)},function(){s(!1)})}function a(){delete t.User,e.defaults.headers.common.Authorization=""}var s={};return s.Login=o,s.Logout=a,s}app.factory("authService",e),e.$inject=["$http","$localStorage","apiService","userService"]}(),function(){"use strict";function e(){var e={},t="";return{updateUser:function(t){e=t},getUser:function(){return e},setToken:function(e){t=e},getToken:function(){return t}}}app.service("userService",e)}(),app.controller("ChatController",["$scope","$location","$localStorage","apiService","authService","userService",function(e,t,n,r,o,a){function s(e){return e<10?"0"+e:e}function i(){$("#conversation .body").stop().animate({scrollTop:$("#conversation .body").prop("scrollHeight")},500)}var c,u=!1;e.conversations={};var l={type:"api/users/"+n.User.username,requestType:"GET"};r.gatewayCall(l).then(function(r){r.data.success?(a.updateUser(r.data.user),e.user=r.data.user,"cedric"==e.user.username?(e.chatConversations=[{_id:"123456789abd",name:"Serge Harb",username:"surgeharb",profilePicture:"http://files.sergeharb.com/img/Me.jpg",lastmessage:{content:"Hello Man",status:"none",date:"22/02/2012 11:12:11"}}],e.conversations.surgeharb=[{date:"22/02/2012 11:12:11",content:"Hello Man",sender:"cedric",receiver:"surgeharb"}]):(e.chatConversations=[{_id:"123456789abc",name:"Cedric Harb",username:"cedric",profilePicture:"https://scontent-mxp1-1.xx.fbcdn.net/v/t1.0-9/10981992_854381584636591_4594131235025284689_n.jpg?oh=0177b6d4c5e300a93cfa20de639bd235&oe=592BF9D9",lastmessage:{content:"Hello Man",status:"none",date:"22/02/2012 11:12:11"}}],e.conversations.cedric=[{date:"22/02/2012 11:12:11",content:"Hello Man",sender:"cedric",receiver:"surgeharb"}]),c=io.connect("http://localhost:12345"),c.on("connect",function(){c.emit("authenticate","STS "+n.User.token,e.user.username)}),c.on("auth",function(n){n?(u=!0,c.emit("join",e.user.username),c.on("update",function(e){console.log(e)}),c.on("receive",function(t){if(t.sender==e.user.username)e.conversations[t.receiver].push(t),e.$apply();else{if(t.receiver!=e.user.username)return!1;e.conversations[t.sender].push(t),e.$apply()}})):(o.Logout(),t.path("/login"),alert("An error has occured please login again!"),e.$apply())})):(alert("An error has occured please login again!"),o.Logout(),t.path("/login"),e.apply())}),e.conv={},e.conv.user={},e.sendMessage=function(){if(e.message&&u){var t=new Date,n={date:s(t.getDate())+"/"+s(t.getMonth()+1)+"/"+s(t.getFullYear())+" "+s(t.getHours())+":"+s(t.getMinutes())+":"+s(t.getSeconds()),content:e.message,sender:e.user.username,receiver:e.conv.user.username};c.emit("send",n),e.message="",n={},i()}},e.checkEnter=function(t){13===t.keyCode&&e.sendMessage()},e.getTime=function(e){var t=e.split(" ")[1],n=t.split(":");return s(parseInt(n[0]))+":"+s(parseInt(n[1]))},e.fetchConversation=function(t){e.conv.user._id=t._id,e.conv.user.name=t.name,e.conv.user.username=t.username,e.conv.user.profilePicture=t.profilePicture}}]),app.controller("LoginController",["$scope","$location","authService",function(e,t,n){e.login=function(){n.Login(e.username,e.password,function(n){n?t.path("/"):(e.error="Your username or password is incorrect",e.loading=!1)})}}]);